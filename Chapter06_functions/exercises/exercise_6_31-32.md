## Exercise 6.31

When is it valid to return a reference? A reference to const?

å¥½çš„ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸é‡è¦ä¸”å®¹æ˜“æ··æ·†çš„C++æ¦‚å¿µã€‚æˆ‘æ¥è¯¦ç»†è§£é‡Šä¸€ä¸‹ï¼š

## ğŸ¯ æ ¸å¿ƒåŸåˆ™ï¼šè¿”å›çš„å¼•ç”¨å¿…é¡»æŒ‡å‘**å‡½æ•°è°ƒç”¨åä»ç„¶å­˜åœ¨çš„å¯¹è±¡**

---

## âœ… é€‚åˆè¿”å›**æ™®é€šå¼•ç”¨**çš„æƒ…å†µ

### 1. è¿”å›**å‡½æ•°å‚æ•°**çš„å¼•ç”¨
å½“å‚æ•°æœ¬èº«æ˜¯é€šè¿‡å¼•ç”¨ä¼ é€’ï¼Œä¸”å¸Œæœ›åœ¨å‡½æ•°å¤–ä¿®æ”¹åŸå¯¹è±¡æ—¶ï¼š

```cpp
// è¿”å›æ•°ç»„å…ƒç´ çš„å¼•ç”¨ï¼Œå…è®¸ä¿®æ”¹
int& getElement(int* arr, int index) {
    return arr[index];  // arråœ¨å‡½æ•°ç»“æŸåä»ç„¶å­˜åœ¨
}

// è¿”å›å­—ç¬¦ä¸²ä¸­æŸä¸ªå­—ç¬¦çš„å¼•ç”¨
char& getChar(std::string& str, size_t pos) {
    return str[pos];    // stråœ¨å‡½æ•°ç»“æŸåä»ç„¶å­˜åœ¨
}

int main() {
    int array[10];
    getElement(array, 5) = 100;  // ç›´æ¥ä¿®æ”¹array[5]
    
    std::string s = "hello";
    getChar(s, 0) = 'H';         // ç›´æ¥ä¿®æ”¹s[0]
}
```

### 2. è¿”å›**ç±»æˆå‘˜**çš„å¼•ç”¨
åœ¨ç±»çš„æˆå‘˜å‡½æ•°ä¸­è¿”å›æˆå‘˜å˜é‡çš„å¼•ç”¨ï¼š

```cpp
class Student {
private:
    std::string name;
public:
    // è¿”å›åå­—çš„å¼•ç”¨ï¼Œå…è®¸å¤–éƒ¨ä¿®æ”¹
    std::string& getName() { return name; }
    
    // è¿”å›å¸¸é‡å¼•ç”¨ï¼Œåªè¯»è®¿é—®
    const std::string& getName() const { return name; }
};

Student stu;
stu.getName() = "Alice";  // ç›´æ¥ä¿®æ”¹æˆå‘˜å˜é‡
```

### 3. è¿”å›**é™æ€å˜é‡**æˆ–**å…¨å±€å˜é‡**çš„å¼•ç”¨
è¿™äº›å˜é‡çš„ç”Ÿå‘½å‘¨æœŸä¸ç¨‹åºç›¸åŒï¼š

```cpp
int& getCounter() {
    static int count = 0;  // é™æ€å˜é‡ï¼Œç¨‹åºç»“æŸå‰ä¸€ç›´å­˜åœ¨
    return count;
}

getCounter() = 42;  // ç›´æ¥ä¿®æ”¹é™æ€å˜é‡
```

### 4. å®ç°**é“¾å¼è°ƒç”¨**
å¸¸è§äºæ“ä½œç¬¦é‡è½½å’Œæµæ“ä½œï¼š

```cpp
class MyVector {
public:
    MyVector& operator+=(const MyVector& other) {
        // å®ç°ç›¸åŠ é€»è¾‘
        return *this;  // è¿”å›è‡ªèº«å¼•ç”¨ï¼Œæ”¯æŒé“¾å¼è°ƒç”¨
    }
};

MyVector v1, v2, v3;
v1 += v2 += v3;  // é“¾å¼è°ƒç”¨
```

---

## âœ… é€‚åˆè¿”å›**å¸¸é‡å¼•ç”¨**çš„æƒ…å†µ

### 1. æä¾›**åªè¯»è®¿é—®**
å½“å¸Œæœ›è°ƒç”¨è€…èƒ½å¤Ÿè¯»å–ä½†ä¸èƒ½ä¿®æ”¹å¯¹è±¡æ—¶ï¼š

```cpp
class Database {
private:
    std::vector<User> users;
public:
    // è¿”å›å¸¸é‡å¼•ç”¨ï¼Œé˜²æ­¢å¤–éƒ¨ä¿®æ”¹ç”¨æˆ·æ•°æ®
    const User& getUser(size_t id) const {
        return users[id];
    }
};

Database db;
const User& user = db.getUser(123);
// user.name = "Bob";  // é”™è¯¯ï¼ä¸èƒ½ä¿®æ”¹å¸¸é‡å¼•ç”¨
```

### 2. é¿å…ä¸å¿…è¦çš„æ‹·è´
å¯¹äºå¤§å‹å¯¹è±¡ï¼Œè¿”å›å¸¸é‡å¼•ç”¨æ¯”è¿”å›å€¼æ›´é«˜æ•ˆï¼š

```cpp
class Document {
private:
    std::string content;  // å¯èƒ½å¾ˆå¤§çš„å­—ç¬¦ä¸²
public:
    // è¿”å›å¸¸é‡å¼•ç”¨ï¼Œé¿å…æ‹·è´æ•´ä¸ªå­—ç¬¦ä¸²
    const std::string& getContent() const { 
        return content; 
    }
};

Document doc;
// åªæ˜¯è¯»å–ï¼Œä¸éœ€è¦æ‹·è´æ•´ä¸ªå­—ç¬¦ä¸²
std::cout << doc.getContent().substr(0, 100);
```

### 3. æ¯”è¾ƒå‡½æ•°æˆ–æŸ¥è¯¢å‡½æ•°
å‡½æ•°åªè¿›è¡Œæ¯”è¾ƒæˆ–æŸ¥è¯¢ï¼Œä¸ä¿®æ”¹ä»»ä½•å†…å®¹ï¼š

```cpp
const std::string& shorterString(const std::string& s1, 
                                 const std::string& s2) {
    return s1.size() <= s2.size() ? s1 : s2;
}

std::string a = "hello", b = "world";
const std::string& result = shorterString(a, b);
// resultæ˜¯aæˆ–bçš„å¼•ç”¨ï¼Œä¸ä¼šäº§ç”Ÿæ‹·è´
```

---

## âŒ ç»å¯¹ä¸èƒ½è¿”å›å¼•ç”¨çš„æƒ…å†µ

### è¿”å›å±€éƒ¨å˜é‡çš„å¼•ç”¨
```cpp
// ä¸¥é‡é”™è¯¯ï¼
const std::string& badFunction() {
    std::string local = "hello";  // å±€éƒ¨å˜é‡
    return local;  // å‡½æ•°ç»“æŸålocalè¢«é”€æ¯ï¼Œå¼•ç”¨æ‚¬ç©º
}

// åŒæ ·é”™è¯¯ï¼
int& anotherBadFunction() {
    int x = 42;
    return x;  // xåœ¨å‡½æ•°ç»“æŸæ—¶è¢«é”€æ¯
}
```

### è¿”å›ä¸´æ—¶å¯¹è±¡çš„å¼•ç”¨
```cpp
// é”™è¯¯ï¼
const std::string& badReturn() {
    return "hello";  // ä¸´æ—¶å­—ç¬¦ä¸²ï¼Œå‡½æ•°ç»“æŸå³é”€æ¯
}
```

---

## ğŸ“‹ å†³ç­–æŒ‡å—

| åœºæ™¯ | è¿”å›ç±»å‹ | åŸå›  |
|------|----------|------|
| å…è®¸ä¿®æ”¹æ•°ç»„å…ƒç´  | `int&` | ç›´æ¥ä¿®æ”¹åŸæ•°æ® |
| å…è®¸ä¿®æ”¹ç±»æˆå‘˜ | `std::string&` | æä¾›å†™è®¿é—® |
| åªè¯»è®¿é—®å¤§å‹å¯¹è±¡ | `const std::string&` | é¿å…æ‹·è´ï¼Œä¿æŠ¤æ•°æ® |
| æ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡ | `const T&` | ä¸ä¿®æ”¹å‚æ•°ï¼Œé¿å…æ‹·è´ |
| é“¾å¼æ“ä½œ | `ClassName&` | è¿”å›è‡ªèº«å¼•ç”¨ |
| æŸ¥è¯¢å‡½æ•° | `const T&` | åªè¯»ï¼Œé«˜æ•ˆ |
| è¿”å›è®¡ç®—ç»“æœ | `T` (å€¼) | å±€éƒ¨ä¸´æ—¶å¯¹è±¡ï¼Œå¿…é¡»æ‹·è´ |

---

## ğŸ’¡ å®ç”¨æ£€æŸ¥æ¸…å•

åœ¨å†³å®šè¿”å›å¼•ç”¨å‰ï¼Œé—®è‡ªå·±ï¼š
1. **è¿™ä¸ªå¯¹è±¡åœ¨å‡½æ•°è¿”å›åè¿˜ä¼šå­˜åœ¨å—ï¼Ÿ**
2. **è°ƒç”¨è€…éœ€è¦ä¿®æ”¹è¿™ä¸ªå¯¹è±¡å—ï¼Ÿ**ï¼ˆæ˜¯â†’æ™®é€šå¼•ç”¨ï¼Œå¦â†’å¸¸é‡å¼•ç”¨ï¼‰
3. **è¿”å›è¿™ä¸ªå¼•ç”¨å®‰å…¨å—ï¼Ÿä¼šä¸ä¼šå¯¼è‡´æ‚¬ç©ºå¼•ç”¨ï¼Ÿ**

**ç®€å•è®°å¿†ï¼š**
- **æƒ³ä¿®æ”¹** â†’ æ™®é€šå¼•ç”¨
- **åªæƒ³è¯»** â†’ å¸¸é‡å¼•ç”¨  
- **å±€éƒ¨å˜é‡** â†’ è¿”å›å€¼ï¼ˆæ‹·è´ï¼‰
- **å‚æ•°/æˆå‘˜** â†’ å¯ä»¥è€ƒè™‘å¼•ç”¨

è¿™æ ·çš„è®¾è®¡æ—¢èƒ½ä¿è¯æ•ˆç‡ï¼Œåˆèƒ½ç¡®ä¿ä»£ç çš„å®‰å…¨æ€§ã€‚

## Exercise 6.32

Indicate whether the following function is legal. If so, explain
what it does; if not, correct any errors and then explain it.

**ä½ çš„ç­”æ¡ˆåˆ†æï¼š**
ä½ çš„ç†è§£åŸºæœ¬æ­£ç¡®ï¼Œä½†è§£é‡Šå¯ä»¥æ›´è¯¦ç»†ã€‚

**æ ‡å‡†ç­”æ¡ˆï¼š**
```cpp
int &get(int *arry, int index) { return arry[index]; }
int main() {
    int ia[10];
    for (int i = 0; i != 10; ++i)
        get(ia, i) = i;  // åˆæ³•ï¼šå°†ia[i]èµ‹å€¼ä¸ºi
}
```
**è§£é‡Šï¼š**
- å‡½æ•°`get`è¿”å›æ•°ç»„å…ƒç´ çš„å¼•ç”¨
- å› ä¸ºè¿”å›çš„æ˜¯å¼•ç”¨ï¼Œæ‰€ä»¥å¯ä»¥ä½œä¸ºå·¦å€¼è¿›è¡Œèµ‹å€¼
- å¾ªç¯ç»“æŸåï¼Œæ•°ç»„`ia`å°†è¢«åˆå§‹åŒ–ä¸º`{0, 1, 2, 3, 4, 5, 6, 7, 8, 9}`

