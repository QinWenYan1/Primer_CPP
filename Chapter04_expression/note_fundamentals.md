# 📘 4.1 Fundamentals（表达式基础）

> 基于《C++ Primer》第五版。本节讨论表达式求值的基本规则，包括运算符类型、分组与结合性、操作数类型转换、运算符重载、左值与右值，以及表达式的求值顺序等核心概念。

---

## 🧠 本节核心概念

* 一元运算符与二元运算符
* 运算符的分组：优先级与结合性
* 操作数类型转换（隐式提升）
* 运算符重载
* 左值（lvalue）与右值（rvalue）
* 表达式的求值顺序（未定义行为）

---

## ✅ 一元运算符与二元运算符

* **一元运算符（unary）**：作用于一个操作数，如 `*`（解引用）、`&`（取地址）、`++i`
* **二元运算符（binary）**：作用于两个操作数，如 `+`、`-`、`==`
* **三元运算符 (ternary)**：作用与三个操作数，如函数调用（甚至可以作用无数个操作符）
* **运算符多义性**：如 `*` 既可作一元（解引用），又可作二元（乘法）。

---

## ✅ 操作数和数算数的结合

* **优先级（precedence）**：决定哪个运算符优先结合操作数。
* **结合性（associativity）**：决定同优先级运算符的结合方向（默认从左往右结合）。

例子：

```cpp
int result = 5 + 10 * 20 / 2;
// 等价于 5 + ((10 * 20) / 2) → 105
```

* **优先级更高的运算先进行**（`* /` 高于 `+`）。
* **结合性**：大多数算术运算符左结合。例如：

```cpp
int x = 20 - 15 - 3; // (20 - 15) - 3 = 2
```

---

## ✅ 操作数类型转换（Conversions）

* 表达式计算时，操作数类型可能会隐式转换。
* **整数提升（integral promotion）**：较小的整型（`bool, char, short`）自动提升为 `int`。
* **常见规则**：

  * `int + double → double`
  * `unsigned + int → unsigned`

⚠️ **注意**：

* 不允许指针与浮点数相互转换。
* 类型转换有时导致精度丢失。

---

## ✅ 运算符重载 (Operator Overloaded)

* **内建类型**：运算符的含义由语言规定。
* **类类型**：可以自定义运算符的行为（如 `string` 定义了 `+` 拼接）。
* 示例：IO 库中 `<<` 和 `>>` 就是重载过的运算符。

```cpp
std::cout << "Hello";   // << 输出运算符重载
std::cin >> x;          // >> 输入运算符重载
```

---

## ✅ 左值与右值

### 📝 什么是左值右值

* **左值（lvalue）**：表示对象的身份（在内存中的位置）或函数名字

  * 可以出现在赋值号左侧。
  * 例：变量名、解引用表达式 `*p`。
* **右值（rvalue）**：表示对象的值（内容）。

  * 不能作为赋值目标。
  * 例：字面值 `42`，表达式 `x+1`。
* **区别**:

  * 左值可以充当右值，但右值不能充当左值
  * 当左值充当右值时，其实使用的是对象的内容

```cpp
int a = 5;   // a 是左值，5 是右值
int b = a;   // a 转换为右值使用 
```
⚠️ **注意**：有些表达式看似左值，但不能作为赋值目标，例如 `const` 对象
### 📝 运算符与 lvalue/rvalue

* **赋值运算符 `=`**

  * 左操作数必须是 **(非 const) lvalue**
  * 结果是 lvalue（返回左操作数本身）

* **取地址运算符 `&`**

  * 操作数必须是 lvalue
  * 结果是 rvalue（一个指针值）

* **解引用 `*` 和 下标 `[]`**

  * 结果都是 lvalue

* **迭代器与容器的 `[]` / `string` / `vector` 下标**

  * 结果都是 lvalue

* **自增/自减运算符**

  * **前置版 (++i, --i)**：接受一个lvalue，结果是 lvalue，因为先自增，再返回变量对象本身 
  * **后置版 (i++, i--)**：接受lvalue，结果是 rvalue, 因为先保存原始对象，然后返回临时值，没有储存空间

### 📝 `decltype` 与左值右值

* `decltype(expr)` 的推导结果依赖于 expr 是否为 lvalue：

  * lvalue → 推导为 **引用类型**: 
  比如 p为 `int*`时，`decltype(*p)` 推倒为 `int&`
  * rvalue → 推导为 **普通类型**:
   比如 p为`int*`时，`decltype(&p)` 推倒为 `int**`


---
## ✅ 优先性和结合性
### 📝 什么是结合性和优先性
- **复合表达式 (compound expression)**：包含两个或多个运算符的表达式
- 优先级和结合性决定了在复杂表达式里，哪个运算符先结合，以及它“抓取”的操作数是哪一部分
- 我们可以覆盖这些规则通过使用括号来强制表达式里面的特定结合

### 📝 括号来覆盖结合性和优先性
- 在含有括号表达式中，被括号作用的子表达式被视作一个单元，其他没有被括号作用的则依照默认的结合性和优先性

  ```cpp
  cout << (6 + 3) * (4 / 2 + 2);   // 输出 36
  cout << ((6 + 3) * 4) / 2 + 2;   // 输出 20
  ```

### 📝 什么时候优先性和结合性重要？
- 指针运算：
  ```cpp
  int ia[] = {0, 2, 4, 6, 8};
  int last = *(ia + 4);  // 取 ia[4] 的值
  last = *ia + 4;        // 相当于 ia[0] + 4
  ```
  - 如果没有括号的话 `*ia` 会先结合 再将4加入到`*ia`的值

- IO运算:
  ```cpp
  cin >> v1 >> v2; //读入v1后再读入到v2
  ```

---

## ✅ 表达式的求值顺序

* C++ 并不保证大多数运算的求值顺序。
* **未定义行为**：如果同一个对象在一次表达式中既被修改又被读取，结果不可预期。

```cpp
int i = 0;
std::cout << i << " " << ++i << std::endl; // ❌ 未定义
```

解释：

* `i` 与 `++i` 的求值顺序不确定。
* 编译器可能先打印 `0 1`，也可能 `1 1`，甚至崩溃。

⚠️ **建议**：

1. 避免在同一表达式中多次修改同一对象。
2. **规则**：逻辑与 `&&`、逻辑或 `||`、条件运算符 `?:`、逗号运算符 `,` 会保证顺序，其它大多数运算不会。

---

## ✅ 求值顺序与优先性和结合性的关系
- 求值顺序是完全独立于优先性和结合性的
```cpp
f() + g() * h() + j()
```
- 优先性保证了 `g()` 和 `h()` 相乘
- 结合性保证了 `f()` 与 `g()` 和 `h()` 的积相加，结果再与 `j()` 相加
- 但没有任何对**函数调用**的保证
- 如果这四个函数没有影响到同一个对象，那么调用顺序并不重要
- 但是其中有函数影响到同一个对象，那么表达式的表现未定义甚至报错

⚠️ **建议**：
1. 当有疑问时，**加括号**：用括号强制表达式的分组，确保逻辑和程序需求一致。
2. **不要**在同一表达式中多次使用被修改的操作数：如果在表达式里改变了某个操作数，就不要在同一表达式的别处再次使用它

⚠️ **例外情况**: 
- 改变操作数的子表达式”本身就是“另一个子表达式的操作数
- 例如 `*++iter` 
修改操作数的子表达式会先执行，再交给外层解引用运算符使用，属于安全且常见的写法

---

## 🔑 小结

* **表达式基础**：由运算符和操作数组成。
* **运算符分类**：一元（`* & ++`）、二元（`+ - * /`）、三元（`?:`）。
* **优先级与结合性**：

  * 优先级决定谁先结合；结合性决定同级运算的方向（多为左结合）。
  * 括号可改变默认规则。
* **类型转换**：小整数会隐式提升为 `int`，常见规则：

  * `int + double → double`
  * `unsigned + int → unsigned`
* **运算符重载**：类可重载运算符，如 `string + string`，IO 使用 `<< >>`。
* **左值与右值**：

  * 左值表示位置（可取地址），右值表示内容（临时值）。
  * 左值能作右值用，反之不行。
* **求值顺序**：大多数运算无序；如果同一对象在一次表达式里既被修改又被读取 → 未定义行为。

  * 特例：`&&`、`||`、`?:`、`,` 保证顺序。
* **经验法则**：

  1. 不确定就加括号。
  2. 不要在同一表达式中同时修改并使用同一变量。

---

## 📌 考试速记

* **运算符**：一元 `* & ++`；二元 `+ - * /`；三元 `?:`
* **优先级口诀**：先 `* /`，后 `+ -`，默认左结合
* **类型转换**：小整型 → `int`；`int+double → double`；`unsigned+int → unsigned`
* **重载**：IO `<< >>`，string `+` 拼接
* **左值/右值**：左值=位置，右值=内容；左能当右，右不能当左
* **未定义行为口诀**：**同一对象，一读一写，结果不稳**
* **安全写法**：加括号，别多次改同一个变量

