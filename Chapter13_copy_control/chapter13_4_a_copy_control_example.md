# ğŸ“˜ 13.4 ä¸€ä¸ªæ‹·è´æ§åˆ¶çš„ä¾‹å­ (A Copy-Control Example)

> æ¥æºè¯´æ˜ï¼šC++ Primer 13.4 | æœ¬èŠ‚æ¶µç›–ï¼šé€šè¿‡è®¾è®¡Messageå’ŒFolderç±»ï¼Œå±•ç¤ºéœ€è¦ç®¡ç†å¯¹è±¡é—´å…³ç³»çš„ç±»å¦‚ä½•å®šä¹‰æ‹·è´æ§åˆ¶æˆå‘˜ã€‚

---

## ğŸ§  æ ¸å¿ƒæ¦‚å¿µæ€»è§ˆï¼ˆä¸¥æ ¼æŒ‰åŸæ–‡é¡ºåºï¼‰

* [*çŸ¥è¯†ç‚¹1: æ‹·è´æ§åˆ¶çš„ç›®çš„ä¸é™äºèµ„æºç®¡ç†*](#id1)
* [*çŸ¥è¯†ç‚¹2: Messageå’ŒFolderç±»çš„è®¾è®¡éœ€æ±‚*](#id2)
* [*çŸ¥è¯†ç‚¹3: Messageç±»çš„æ‹·è´æ§åˆ¶æ“ä½œåˆ†æ*](#id3)
* [*çŸ¥è¯†ç‚¹4: Best Practices: å°è£…å…¬å…±æ“ä½œ*](#id4)
* [*çŸ¥è¯†ç‚¹5: Messageç±»çš„å®šä¹‰*](#id5)
* [*çŸ¥è¯†ç‚¹6: saveå’Œremoveæˆå‘˜å‡½æ•°çš„å®ç°*](#id6)
* [*çŸ¥è¯†ç‚¹7: æ‹·è´æ§åˆ¶å…¬ç”¨å·¥å…·å‡½æ•°add_to_Folders*](#id7)
* [*çŸ¥è¯†ç‚¹8: æ‹·è´æ„é€ å‡½æ•°çš„å®ç°*](#id8)
* [*çŸ¥è¯†ç‚¹9: æ‹·è´æ§åˆ¶å…¬ç”¨å·¥å…·å‡½æ•°remove_from_Folders*](#id9)
* [*çŸ¥è¯†ç‚¹10: ææ„å‡½æ•°çš„å®ç°*](#id10)
* [*çŸ¥è¯†ç‚¹11: æ‹·è´èµ‹å€¼è¿ç®—ç¬¦çš„å®ç°*](#id11)
* [*çŸ¥è¯†ç‚¹12: è‡ªå®šä¹‰swapå‡½æ•°çš„éœ€æ±‚ä¸å®ç°*](#id12)

---

<a id="id1"></a>
## âœ… çŸ¥è¯†ç‚¹1: æ‹·è´æ§åˆ¶çš„ç›®çš„ä¸é™äºèµ„æºç®¡ç†

**ç†è®º**
* **æ ¸å¿ƒä¸»æ—¨æ€»ç»“**ï¼šå®šä¹‰æ‹·è´æ§åˆ¶æˆå‘˜ï¼ˆæ‹·è´æ„é€ å‡½æ•°ã€æ‹·è´èµ‹å€¼è¿ç®—ç¬¦ã€ææ„å‡½æ•°ï¼‰æœ€å¸¸è§çš„åŸå› æ˜¯ä¸ºäº†ç®¡ç†åŠ¨æ€åˆ†é…çš„èµ„æºï¼ˆå¦‚å†…å­˜ï¼‰ã€‚ç„¶è€Œï¼Œ**èµ„æºç®¡ç†å¹¶éå”¯ä¸€åŸå› **ã€‚æœ‰äº›ç±»éœ€è¦è¿›è¡Œâ€œç°¿è®°(bookkeeping)â€æˆ–æ‰§è¡Œå…¶ä»–å¿…é¡»åœ¨æ‹·è´æ§åˆ¶æˆå‘˜ä¸­å®Œæˆçš„æ“ä½œã€‚

---

<a id="id2"></a>
## âœ… çŸ¥è¯†ç‚¹2: Messageå’ŒFolderç±»çš„è®¾è®¡éœ€æ±‚

**ç†è®º**
* **æ ¸å¿ƒä¸»æ—¨æ€»ç»“**ï¼šæœ¬èŠ‚é€šè¿‡ä¸€ä¸ªé‚®ä»¶å¤„ç†åº”ç”¨çš„ä¾‹å­ï¼Œå±•ç¤ºéœ€è¦â€œç°¿è®°â€çš„ç±»å¦‚ä½•å®ç°æ‹·è´æ§åˆ¶ã€‚è®¾è®¡äº†ä¸¤ä¸ªç±»ï¼š
    1. **`Message`**ï¼šä»£è¡¨ç”µå­é‚®ä»¶ï¼ˆæˆ–å…¶ä»–ï¼‰æ¶ˆæ¯ã€‚
    2. **`Folder`**ï¼šä»£è¡¨æ¶ˆæ¯å¯èƒ½å‡ºç°çš„ç›®å½•ã€‚
* **å…³é”®è®¾è®¡è¦æ±‚**ï¼š
    1. ä¸€ä¸ª `Message` å¯ä»¥å‡ºç°åœ¨å¤šä¸ª `Folder` ä¸­ã€‚
    2. **ä»»ä½•ç»™å®š `Message` çš„å†…å®¹åªæœ‰ä¸€ä»½æ‹·è´**ã€‚è¿™æ ·ï¼Œå½“ä¿®æ”¹ä¸€ä¸ª `Message` çš„å†…å®¹æ—¶ï¼Œä»ä»»ä½•åŒ…å«å®ƒçš„ `Folder` ä¸­æŸ¥çœ‹ï¼Œéƒ½èƒ½çœ‹åˆ°ä¿®æ”¹ã€‚
* **å…³ç³»ç»´æŠ¤æœºåˆ¶**ï¼š
    1. æ¯ä¸ª `Message` ä¿å­˜ä¸€ä¸ªæŒ‡å‘å…¶æ‰€åœ¨ `Folder` çš„æŒ‡é’ˆé›†åˆ(`set`)ã€‚
    2. æ¯ä¸ª `Folder` ä¿å­˜ä¸€ä¸ªæŒ‡å‘å…¶åŒ…å«çš„ `Message` çš„æŒ‡é’ˆé›†åˆã€‚
    *ï¼ˆæ•™æä¸­çš„Figure 13.1å›¾ç¤ºäº†è¿™ç§è®¾è®¡ï¼‰*
* **æ“ä½œå®šä¹‰**ï¼š
    1. **`save`**ï¼šå°† `Message` æ·»åŠ åˆ°æŒ‡å®šçš„ `Folder`ã€‚
    2. **`remove`**ï¼šå°† `Message` ä»æŒ‡å®šçš„ `Folder` ä¸­åˆ é™¤ã€‚
    3. **åˆ›å»ºæ–° `Message`**ï¼šåªæŒ‡å®šå†…å®¹ï¼Œä¸å…³è”ä»»ä½• `Folder`ã€‚

**æ³¨æ„ç‚¹**
* ğŸ”„ **çŸ¥è¯†å…³è”**ï¼šè¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„**å¯¹è±¡é—´å…³ç³»ç®¡ç†**çš„ä¾‹å­ï¼Œæ‹·è´æ§åˆ¶éœ€è¦åŒæ­¥æ›´æ–°è¿™äº›å…³ç³»ï¼Œè€Œä¸ä»…ä»…æ˜¯å¤åˆ¶æ•°æ®ã€‚

---

<a id="id3"></a>
## âœ… çŸ¥è¯†ç‚¹3: Messageç±»çš„æ‹·è´æ§åˆ¶æ“ä½œåˆ†æ

**ç†è®º**
* **æ ¸å¿ƒä¸»æ—¨æ€»ç»“**ï¼šåˆ†æ`Message`å¯¹è±¡åœ¨å„ç§æ“ä½œä¸‹ï¼Œåº”å¦‚ä½•ç»´æŠ¤ä¸`Folder`å¯¹è±¡çš„å…³ç³»ã€‚
    1. **æ‹·è´æ„é€ (Copy a `Message`)**ï¼š
        * å‰¯æœ¬å’ŒåŸå¯¹è±¡æ˜¯**ä¸åŒçš„ `Message` å¯¹è±¡**ã€‚
        * ä½†ä¸¤è€…åº”å‡ºç°åœ¨**ç›¸åŒçš„ `Folder` é›†åˆ**ä¸­ã€‚
        * å› æ­¤éœ€è¦ï¼š**æ‹·è´å†…å®¹**å’Œ **`Folder` æŒ‡é’ˆé›†åˆ**ï¼Œå¹¶ä¸”**åœ¨æ¯ä¸ªç›¸å…³çš„ `Folder` ä¸­æ·»åŠ ä¸€ä¸ªæŒ‡å‘æ–° `Message` çš„æŒ‡é’ˆ**ã€‚
    2. **é”€æ¯(Destroy a `Message`)**ï¼š
        * å¯¹è±¡ä¸å¤å­˜åœ¨ï¼Œå¿…é¡»**ä»æ‰€æœ‰æ›¾åŒ…å«å®ƒçš„ `Folder` ä¸­ç§»é™¤æŒ‡å‘å®ƒçš„æŒ‡é’ˆ**ã€‚
    3. **æ‹·è´èµ‹å€¼(Copy-assign one `Message` to another)**ï¼š
        * **æ›¿æ¢**å·¦ä¾§å¯¹è±¡çš„å†…å®¹ä¸ºå³ä¾§å¯¹è±¡çš„å†…å®¹ã€‚
        * **æ›´æ–° `Folder` é›†åˆ**ï¼šå°†å·¦ä¾§å¯¹è±¡ä»å…¶åŸ `Folder` ä¸­**ç§»é™¤**ï¼Œå¹¶å°†å…¶**æ·»åŠ **åˆ°å³ä¾§å¯¹è±¡æ‰€åœ¨çš„ `Folder` ä¸­ã€‚
* **æ“ä½œå…±é€šæ€§åˆ†æ**ï¼š
    * **ææ„å‡½æ•°**å’Œ**æ‹·è´èµ‹å€¼è¿ç®—ç¬¦**éƒ½éœ€è¦**ä»ç›¸å…³ `Folder` ä¸­ç§»é™¤å½“å‰ `Message`**ã€‚
    * **æ‹·è´æ„é€ å‡½æ•°**å’Œ**æ‹·è´èµ‹å€¼è¿ç®—ç¬¦**éƒ½éœ€è¦**å°†å½“å‰ `Message` æ·»åŠ åˆ°ä¸€ç»„ `Folder` ä¸­**ã€‚
    * å› æ­¤ï¼Œå¯ä»¥å®šä¹‰**ç§æœ‰å·¥å…·å‡½æ•°(private utility functions)** æ¥å®Œæˆè¿™äº›å…¬å…±ä»»åŠ¡ã€‚

---

<a id="id4"></a>
## âœ… çŸ¥è¯†ç‚¹4: Best Practices: å°è£…å…¬å…±æ“ä½œ

**ç†è®º**
* **æ ¸å¿ƒä¸»æ—¨æ€»ç»“**ï¼šæ‹·è´èµ‹å€¼è¿ç®—ç¬¦é€šå¸¸éœ€è¦å®Œæˆä¸æ‹·è´æ„é€ å‡½æ•°å’Œææ„å‡½æ•°ç›¸åŒçš„å·¥ä½œã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ**åº”è¯¥å°†å…¬å…±å·¥ä½œå°è£…åˆ°ç§æœ‰å·¥å…·å‡½æ•°ä¸­**ã€‚
* **`Folder`ç±»çš„è®¾è®¡**ï¼š`Folder` ç±»ä¹Ÿéœ€è¦ç±»ä¼¼çš„æ‹·è´æ§åˆ¶æˆå‘˜æ¥ä»å®ƒå­˜å‚¨çš„ `Message` é›†åˆä¸­æ·»åŠ æˆ–ç§»é™¤è‡ªèº«ã€‚æˆ‘ä»¬å‡è®¾ `Folder` ç±»æœ‰ `addMsg` å’Œ `remMsg` æˆå‘˜ï¼Œåˆ†åˆ«ç”¨äºåœ¨ç»™å®š `Folder` çš„æ¶ˆæ¯é›†åˆä¸­æ·»åŠ æˆ–ç§»é™¤æœ¬ `Message`ã€‚

**æ•™æç¤ºä¾‹ä»£ç **
```cpp
// å‡è®¾ Folder ç±»æœ‰è¿™äº›æˆå‘˜
class Folder {
public:
    void addMsg(Message* msg); // å°† msg æ·»åŠ åˆ°æ­¤ Folder çš„æ¶ˆæ¯é›†åˆä¸­
    void remMsg(Message* msg); // å°† msg ä»æ­¤ Folder çš„æ¶ˆæ¯é›†åˆä¸­ç§»é™¤
    // ... å…¶ä»–æˆå‘˜
};
```

**æ³¨æ„ç‚¹**
* ğŸ’¡ **ç†è§£æŠ€å·§**ï¼šè¯†åˆ«å‡ºæ‹·è´æ§åˆ¶æˆå‘˜ä¸­çš„é‡å¤å·¥ä½œå¹¶æå–ä¸ºå‡½æ•°ï¼Œæ˜¯ç¼–å†™**æ­£ç¡®ã€æ˜“ç»´æŠ¤**æ‹·è´æ§åˆ¶ä»£ç çš„å…³é”®ã€‚

---

<a id="id5"></a>
## âœ… çŸ¥è¯†ç‚¹5: Messageç±»çš„å®šä¹‰

**ç†è®º**
* **æ ¸å¿ƒä¸»æ—¨æ€»ç»“**ï¼šåŸºäºä¸Šè¿°è®¾è®¡ï¼Œç»™å‡º `Message` ç±»çš„å®šä¹‰æ¡†æ¶ã€‚å®ƒåŒ…å«æ•°æ®æˆå‘˜ã€æ„é€ å‡½æ•°ã€æ‹·è´æ§åˆ¶æˆå‘˜ã€å…¬å¼€æ“ä½œä»¥åŠç§æœ‰çš„å·¥å…·å‡½æ•°ã€‚

**æ•™æç¤ºä¾‹ä»£ç **
```cpp
class Message {
    friend class Folder; // å£°æ˜ Folder ä¸ºå‹å…ƒï¼Œä»¥ä¾¿å…¶è®¿é—®ç§æœ‰æˆå‘˜
public:
    // folders è¢«éšå¼åˆå§‹åŒ–ä¸ºç©ºé›†åˆ
    explicit Message(const std::string &str = "") : contents(str) { }
    // æ‹·è´æ§åˆ¶ï¼Œç”¨äºç®¡ç†æŒ‡å‘æ­¤ Message çš„æŒ‡é’ˆ
    Message(const Message&);            // æ‹·è´æ„é€ å‡½æ•°
    Message& operator=(const Message&); // æ‹·è´èµ‹å€¼è¿ç®—ç¬¦
    ~Message();                         // ææ„å‡½æ•°
    // ä»æŒ‡å®š Folder çš„æ¶ˆæ¯é›†åˆä¸­æ·»åŠ /åˆ é™¤æ­¤ Message
    void save(Folder&);
    void remove(Folder&);
private:
    std::string contents;          // å®é™…çš„æ¶ˆæ¯æ–‡æœ¬
    std::set<Folder*> folders;     // åŒ…å«æ­¤ Message çš„ Folder æŒ‡é’ˆé›†åˆ
    // è¢«æ‹·è´æ„é€ å‡½æ•°ã€èµ‹å€¼è¿ç®—ç¬¦å’Œææ„å‡½æ•°ä½¿ç”¨çš„å·¥å…·å‡½æ•°
    void add_to_Folders(const Message&); // å°†æ­¤ Message æ·»åŠ åˆ°å‚æ•° m æ‰€åœ¨çš„æ‰€æœ‰ Folder ä¸­
    void remove_from_Folders();          // ä» folders ä¸­çš„æ¯ä¸ª Folder é‡Œç§»é™¤æ­¤ Message
};
```

**æ³¨æ„ç‚¹**
* ğŸ“‹ **æœ¯è¯­æé†’**ï¼š
    * `explicit` æ„é€ å‡½æ•°ï¼šé˜²æ­¢éšå¼ç±»å‹è½¬æ¢ã€‚
    * `std::set<Folder*>`ï¼šå­˜å‚¨å”¯ä¸€ `Folder` æŒ‡é’ˆçš„å…³è”å®¹å™¨ã€‚
    * å‹å…ƒå£°æ˜(`friend`)ï¼šå…è®¸ `Folder` ç±»è®¿é—® `Message` çš„ç§æœ‰æˆå‘˜ï¼ˆå¦‚ `folders` é›†åˆï¼‰ï¼Œä»¥ä¾¿ `Folder::addMsg/remMsg` èƒ½æ›´æ–°å®ƒã€‚
* âš ï¸ **è­¦å‘Šæ³¨æ„**ï¼šæ‹·è´æ„é€ å‡½æ•°ã€æ‹·è´èµ‹å€¼è¿ç®—ç¬¦å’Œææ„å‡½æ•°**å¿…é¡»æ­£ç¡®ç®¡ç† `folders` é›†åˆ**ï¼Œä»¥ä¿æŒ `Message` å’Œ `Folder` å¯¹è±¡é—´å…³ç³»çš„ä¸€è‡´æ€§ã€‚

---

<a id="id6"></a>
## âœ… çŸ¥è¯†ç‚¹6: saveå’Œremoveæˆå‘˜å‡½æ•°çš„å®ç°

**ç†è®º**
* **æ ¸å¿ƒä¸»æ—¨æ€»ç»“**ï¼š`save` å’Œ `remove` å‡½æ•°è´Ÿè´£æ›´æ–° `Message` å¯¹è±¡ä¸ç‰¹å®š `Folder` å¯¹è±¡çš„åŒå‘å…³ç³»ã€‚
    1. **`save(Folder &f)`**:
        * å°† `Folder f` çš„æŒ‡é’ˆæ’å…¥åˆ°æœ¬ `Message` çš„ `folders` é›†åˆä¸­ã€‚
        * è°ƒç”¨ `f.addMsg(this)`ï¼Œå°†æœ¬ `Message` çš„æŒ‡é’ˆæ·»åŠ åˆ° `Folder f` çš„æ¶ˆæ¯é›†åˆä¸­ã€‚
    2. **`remove(Folder &f)`**:
        * å°† `Folder f` çš„æŒ‡é’ˆä»æœ¬ `Message` çš„ `folders` é›†åˆä¸­åˆ é™¤ã€‚
        * è°ƒç”¨ `f.remMsg(this)`ï¼Œå°†æœ¬ `Message` çš„æŒ‡é’ˆä» `Folder f` çš„æ¶ˆæ¯é›†åˆä¸­åˆ é™¤ã€‚

**æ•™æç¤ºä¾‹ä»£ç **
```cpp
void Message::save(Folder &f) {
    folders.insert(&f);        // å°†ç»™å®š Folder æ·»åŠ åˆ°æˆ‘ä»¬çš„ Folder åˆ—è¡¨ä¸­
    f.addMsg(this);           // å°†æ­¤ Message æ·»åŠ åˆ° f çš„ Message é›†åˆä¸­
}

void Message::remove(Folder &f) {
    folders.erase(&f);        // å°†ç»™å®š Folder ä»æˆ‘ä»¬çš„ Folder åˆ—è¡¨ä¸­ç§»é™¤
    f.remMsg(this);          // å°†æ­¤ Message ä» f çš„ Message é›†åˆä¸­ç§»é™¤
}
```

**æ³¨æ„ç‚¹**
* ğŸ”„ **çŸ¥è¯†å…³è”**ï¼šè¿™æ˜¯ç»´æŠ¤**åŒå‘å…³ç³»**çš„æ ‡å‡†æ¨¡å¼ï¼šåœ¨æ›´æ–°ä¸€æ–¹ï¼ˆ`Message`ï¼‰çš„åŒæ—¶ï¼Œå¿…é¡»é€šè¿‡å¯¹æ–¹çš„æ¥å£ï¼ˆ`Folder::addMsg/remMsg`ï¼‰æ›´æ–°å¦ä¸€æ–¹ã€‚

---

<a id="id7"></a>
## âœ… çŸ¥è¯†ç‚¹7: æ‹·è´æ§åˆ¶å…¬ç”¨å·¥å…·å‡½æ•°add_to_Folders

**ç†è®º**
* **æ ¸å¿ƒä¸»æ—¨æ€»ç»“**ï¼š`add_to_Folders` æ˜¯ä¸€ä¸ªç§æœ‰å·¥å…·å‡½æ•°ï¼Œç”¨äºå°†å½“å‰ `Message` å¯¹è±¡æ·»åŠ åˆ°å¦ä¸€ä¸ª `Message` å¯¹è±¡ï¼ˆå‚æ•° `m`ï¼‰æ‰€åœ¨çš„æ‰€æœ‰ `Folder` ä¸­ã€‚å®ƒè¢«æ‹·è´æ„é€ å‡½æ•°å’Œæ‹·è´èµ‹å€¼è¿ç®—ç¬¦è°ƒç”¨ï¼Œä»¥ç¡®ä¿æ–°å¯¹è±¡ä¸åŸå¯¹è±¡å‡ºç°åœ¨ç›¸åŒçš„ `Folder` é›†åˆä¸­ã€‚

**æ•™æç¤ºä¾‹ä»£ç **
```cpp
// å°†æ­¤ Message æ·»åŠ åˆ°æŒ‡å‘ m çš„æ‰€æœ‰ Folder ä¸­
void Message::add_to_Folders(const Message &m) {
    for (auto f : m.folders)  // å¯¹æ¯ä¸ªåŒ…å« m çš„ Folder
        f->addMsg(this);      // å°†ä¸€ä¸ªæŒ‡å‘æ­¤ Message çš„æŒ‡é’ˆæ·»åŠ åˆ°é‚£ä¸ª Folder
}
```

**æ³¨æ„ç‚¹**
* ğŸ“‹ **æœ¯è¯­æé†’**ï¼š`auto f : m.folders` ä¸­ï¼Œ`f` çš„ç±»å‹æ˜¯ `Folder*`ã€‚
* ğŸ’¡ **ç†è§£æŠ€å·§**ï¼šè¿™ä¸ªå‡½æ•°éå†å‚æ•°å¯¹è±¡ `m` çš„å…³è” `Folder`ï¼Œç„¶åè®©æ¯ä¸ª `Folder` æ¥å…³è”å½“å‰å¯¹è±¡(`this`)ï¼Œå®Œç¾åœ°å®ç°äº†å…³ç³»æ‹·è´ã€‚

---

<a id="id8"></a>
## âœ… çŸ¥è¯†ç‚¹8: æ‹·è´æ„é€ å‡½æ•°çš„å®ç°

**ç†è®º**
* **æ ¸å¿ƒä¸»æ—¨æ€»ç»“**ï¼š`Message` çš„æ‹·è´æ„é€ å‡½æ•°é¦–å…ˆæ‰§è¡Œæˆå‘˜æ‹·è´ï¼ˆå¤åˆ¶ `contents` å’Œ `folders` é›†åˆï¼‰ï¼Œç„¶åè°ƒç”¨ `add_to_Folders` å·¥å…·å‡½æ•°ï¼Œå°†æ–°åˆ›å»ºçš„ `Message` å¯¹è±¡æ·»åŠ åˆ°åŸå¯¹è±¡(`m`)æ‰€åœ¨çš„æ¯ä¸€ä¸ª `Folder` ä¸­ã€‚

**æ•™æç¤ºä¾‹ä»£ç **
```cpp
Message::Message(const Message &m): contents(m.contents), folders(m.folders) {
    add_to_Folders(m); // å°†æ­¤ Message æ·»åŠ åˆ°æŒ‡å‘ m çš„æ‰€æœ‰ Folder ä¸­
}
```

**æ³¨æ„ç‚¹**
* âš ï¸ **è­¦å‘Šæ³¨æ„**ï¼šæ„é€ å‡½æ•°åˆå§‹åŒ–åˆ—è¡¨å®Œæˆäº†æ•°æ®çš„â€œæµ…æ‹·è´â€ï¼ˆå¯¹äºæŒ‡é’ˆé›†åˆ `folders` è€Œè¨€ï¼Œæ‹·è´çš„æ˜¯æŒ‡é’ˆå€¼ï¼Œè€Œä¸æ˜¯ `Folder` å¯¹è±¡æœ¬èº«ï¼‰ã€‚è¿™æ˜¯æ­£ç¡®çš„ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦çš„æ˜¯**ç›¸åŒçš„ `Folder` é›†åˆ**ï¼Œè€Œä¸æ˜¯å®ƒä»¬çš„å‰¯æœ¬ã€‚å…³é”®åœ¨äºä¹‹åè°ƒç”¨ `add_to_Folders` æ¥å»ºç«‹åå‘é“¾æ¥ã€‚

---

<a id="id9"></a>
## âœ… çŸ¥è¯†ç‚¹9: æ‹·è´æ§åˆ¶å…¬ç”¨å·¥å…·å‡½æ•°remove_from_Folders

**ç†è®º**
* **æ ¸å¿ƒä¸»æ—¨æ€»ç»“**ï¼š`remove_from_Folders` æ˜¯ä¸€ä¸ªç§æœ‰å·¥å…·å‡½æ•°ï¼Œç”¨äºå°†å½“å‰ `Message` å¯¹è±¡ä»å…¶å…³è”çš„æ‰€æœ‰ `Folder` ä¸­ç§»é™¤ã€‚å®ƒè¢«ææ„å‡½æ•°å’Œæ‹·è´èµ‹å€¼è¿ç®—ç¬¦è°ƒç”¨ï¼Œä»¥ç¡®ä¿å¯¹è±¡é”€æ¯æˆ–é‡æ–°èµ‹å€¼å‰ï¼Œèƒ½æ­£ç¡®æ¸…ç†ä¸ `Folder` å¯¹è±¡çš„å…³ç³»ã€‚

**æ•™æç¤ºä¾‹ä»£ç **
```cpp
// ä»ç›¸åº”çš„ Folder ä¸­ç§»é™¤æ­¤ Message
void Message::remove_from_Folders() {
    for (auto f : folders) // å¯¹ folders ä¸­çš„æ¯ä¸ªæŒ‡é’ˆ
        f->remMsg(this);   // ä»æ­¤ Folder ä¸­ç§»é™¤æ­¤ Message
}
```

**æ³¨æ„ç‚¹**
* ğŸ”„ **çŸ¥è¯†å…³è”**ï¼šæ­¤å‡½æ•°ä¸ `add_to_Folders` å¯¹ç§°ï¼Œä½†éå†çš„æ˜¯å½“å‰å¯¹è±¡(`this`)è‡ªå·±çš„ `folders` é›†åˆã€‚

---

<a id="id10"></a>
## âœ… çŸ¥è¯†ç‚¹10: ææ„å‡½æ•°çš„å®ç°

**ç†è®º**
* **æ ¸å¿ƒä¸»æ—¨æ€»ç»“**ï¼š`Message` çš„ææ„å‡½æ•°éå¸¸ç®€å•ï¼Œåªéœ€è°ƒç”¨ `remove_from_Folders` æ¥æ¸…é™¤æ‰€æœ‰æŒ‡å‘æœ¬ `Message` çš„ `Folder` æŒ‡é’ˆã€‚å®Œæˆè¿™ä¸€æ­¥åï¼Œ`contents` (`string`) å’Œ `folders` (`set`) æˆå‘˜ä¼šç”±ç¼–è¯‘å™¨è‡ªåŠ¨è°ƒç”¨å„è‡ªçš„ææ„å‡½æ•°è¿›è¡Œèµ„æºæ¸…ç†ã€‚

**æ•™æç¤ºä¾‹ä»£ç **
```cpp
Message::~Message() {
    remove_from_Folders();
}
```

**æ³¨æ„ç‚¹**
* ğŸ’¡ **ç†è§£æŠ€å·§**ï¼šææ„å‡½æ•°çš„å·¥ä½œé¡ºåºé€šå¸¸æ˜¯â€œå…ˆæ¸…ç†å¯¹å¤–éƒ¨èµ„æºçš„å¼•ç”¨æˆ–å…³ç³»ï¼Œå†é”€æ¯è‡ªèº«æˆå‘˜â€ã€‚è¿™é‡Œæ¸…ç†å…³ç³»æ˜¯å¿…é¡»æ‰‹åŠ¨å®Œæˆçš„ï¼Œè€Œæˆå‘˜é”€æ¯æ˜¯è‡ªåŠ¨çš„ã€‚

---

<a id="id11"></a>
## âœ… çŸ¥è¯†ç‚¹11: æ‹·è´èµ‹å€¼è¿ç®—ç¬¦çš„å®ç°

**ç†è®º**
* **æ ¸å¿ƒä¸»æ—¨æ€»ç»“**ï¼šæ‹·è´èµ‹å€¼è¿ç®—ç¬¦éœ€è¦å…¼é¡¾æ‹·è´æ„é€ å‡½æ•°ï¼ˆå»ºç«‹æ–°å…³ç³»ï¼‰å’Œææ„å‡½æ•°ï¼ˆæ¸…ç†æ—§å…³ç³»ï¼‰çš„å·¥ä½œï¼Œå¹¶ä¸”**å¿…é¡»æ­£ç¡®å¤„ç†è‡ªèµ‹å€¼(self-assignment)**ã€‚å®ç°çš„é€šç”¨æ¨¡å¼æ˜¯ï¼šå…ˆæ¸…ç†å·¦ä¾§å¯¹è±¡çš„æ—§çŠ¶æ€ï¼ˆåƒææ„ï¼‰ï¼Œå†æ‹·è´å³ä¾§å¯¹è±¡çš„æ•°æ®ï¼ˆåƒæ‹·è´æ„é€ ï¼‰ï¼Œæœ€åå»ºç«‹æ–°å…³ç³»ã€‚
* **è‡ªèµ‹å€¼å¤„ç†**ï¼šé€šè¿‡**å…ˆè°ƒç”¨ `remove_from_Folders` å†è°ƒç”¨ `add_to_Folders`** æ¥ä¿æŠ¤è‡ªèµ‹å€¼ã€‚å¦‚æœé¡ºåºé¢ å€’ï¼Œåœ¨è‡ªèµ‹å€¼æƒ…å†µä¸‹ï¼Œä¼šå…ˆå°†è‡ªå·±æ·»åŠ åˆ°æ‰€æœ‰ `Folder`ï¼ˆå¯èƒ½é‡å¤æ·»åŠ æˆ–æ— æ•ˆæ“ä½œï¼‰ï¼Œå†å°†è‡ªå·±ä»æ‰€æœ‰ `Folder` ä¸­ç§»é™¤ï¼Œå¯¼è‡´æœ€ç»ˆå…³ç³»è¢«é”™è¯¯æ¸…ç©ºã€‚

**æ•™æç¤ºä¾‹ä»£ç **
```cpp
// é€šè¿‡å…ˆç§»é™¤æŒ‡é’ˆå†æ’å…¥å®ƒä»¬æ¥å¤„ç†è‡ªèµ‹å€¼
Message& Message::operator=(const Message &rhs) {
    remove_from_Folders();   // æ›´æ–°ç°æœ‰çš„ Folders (ç§»é™¤æœ¬å¯¹è±¡)
    contents = rhs.contents; // ä» rhs æ‹·è´æ¶ˆæ¯å†…å®¹
    folders = rhs.folders;   // ä» rhs æ‹·è´ Folder æŒ‡é’ˆ
    add_to_Folders(rhs);     // å°†æ­¤ Message æ·»åŠ åˆ°é‚£äº› Folders ä¸­
    return *this;
}
```

**æ³¨æ„ç‚¹**
* âš ï¸ **è­¦å‘Šæ³¨æ„**ï¼š**æ­£ç¡®å¤„ç†è‡ªèµ‹å€¼æ˜¯æ‹·è´èµ‹å€¼è¿ç®—ç¬¦çš„ç¡¬æ€§è¦æ±‚**ã€‚æ­¤å®ç°é€šè¿‡å…ˆæ–­å¼€æ‰€æœ‰æ—§é“¾æ¥çš„æ–¹å¼ï¼Œå³ä½¿ `rhs` å’Œ `this` æ˜¯åŒä¸€å¯¹è±¡ï¼Œ`folders` é›†åˆåœ¨æ‹·è´æ—¶ä¹Ÿæ˜¯å®Œæ•´çš„ï¼Œä¹‹å `add_to_Folders` ä¼šé‡æ–°å»ºç«‹é“¾æ¥ï¼Œä¿è¯äº†æ­£ç¡®æ€§ã€‚

---

<a id="id12"></a>
## âœ… çŸ¥è¯†ç‚¹12: è‡ªå®šä¹‰swapå‡½æ•°çš„éœ€æ±‚ä¸å®ç°

**ç†è®º**
* **æ ¸å¿ƒä¸»æ—¨æ€»ç»“**ï¼šæ ‡å‡†åº“ä¸º `string` å’Œ `set` å®šä¹‰äº†é«˜æ•ˆçš„ `swap`ï¼Œå› æ­¤ `Message` ç±»è‡ªå®šä¹‰ `swap` å¯ä»¥é¿å…ä¸å¿…è¦çš„æˆå‘˜æ‹·è´ã€‚ä½†æ˜¯ï¼Œç®€å•çš„æˆå‘˜ `swap` ä¼šç ´å `Message` ä¸ `Folder` ä¹‹é—´çš„å…³ç³»ï¼Œå› æ­¤è‡ªå®šä¹‰ `swap` **å¿…é¡»åŒæ­¥æ›´æ–°æ‰€æœ‰ç›¸å…³ `Folder` å¯¹è±¡å†…éƒ¨çš„æŒ‡é’ˆ**ã€‚
* **å®ç°æ­¥éª¤**ï¼š
    1. **ç¬¬ä¸€ééå†**ï¼šå°†ä¸¤ä¸ª `Message` å¯¹è±¡ï¼ˆ`lhs` å’Œ `rhs`ï¼‰åˆ†åˆ«ä»å®ƒä»¬å½“å‰å…³è”çš„æ‰€æœ‰ `Folder` ä¸­ç§»é™¤ã€‚
    2. **äº¤æ¢æ•°æ®æˆå‘˜**ï¼šä½¿ç”¨æ ‡å‡†åº“ `swap` äº¤æ¢ `contents` å’Œ `folders`ã€‚
    3. **ç¬¬äºŒééå†**ï¼šå°†ä¸¤ä¸ª `Message` å¯¹è±¡ï¼ˆæ­¤æ—¶å®ƒä»¬çš„ `folders` é›†åˆå·²äº¤æ¢ï¼‰åˆ†åˆ«æ·»åŠ åˆ°å®ƒä»¬â€œæ–°â€å…³è”çš„æ‰€æœ‰ `Folder` ä¸­ã€‚

**æ•™æç¤ºä¾‹ä»£ç **
```cpp
void swap(Message &lhs, Message &rhs) {
    using std::swap; // ä¸¥æ ¼æ¥è¯´æœ¬ä¾‹ä¸­ä¸éœ€è¦ï¼Œä½†æ˜¯ä¸ªå¥½ä¹ æƒ¯
    // å°†æ¯ä¸ª Message ä»å®ƒä»¬ï¼ˆåŸå§‹ï¼‰å„è‡ªçš„ Folder ä¸­ç§»é™¤æŒ‡é’ˆ
    for (auto f: lhs.folders)
        f->remMsg(&lhs);
    for (auto f: rhs.folders)
        f->remMsg(&rhs);
    // äº¤æ¢ contents å’Œ Folder æŒ‡é’ˆé›†åˆ
    swap(lhs.folders, rhs.folders);   // ä½¿ç”¨ swap(set&, set&)
    swap(lhs.contents, rhs.contents); // swap(string&, string&)
    // å°†æ¯ä¸ª Message æ·»åŠ åˆ°å®ƒä»¬ï¼ˆæ–°ï¼‰å„è‡ªçš„ Folder ä¸­
    for (auto f: lhs.folders)
        f->addMsg(&lhs);
    for (auto f: rhs.folders)
        f->addMsg(&rhs);
}
```

**æ³¨æ„ç‚¹**
* ğŸ“‹ **æœ¯è¯­æé†’**ï¼š`using std::swap;` æ˜¯å¥½ä¹ æƒ¯ï¼Œå®ƒè®©ç¼–è¯‘å™¨åœ¨æŸ¥æ‰¾ `swap` æ—¶èƒ½åŒæ—¶è€ƒè™‘æ ‡å‡†åº“ç‰ˆæœ¬å’Œé€šè¿‡å‚æ•°ä¾èµ–æŸ¥æ‰¾(ADL)æ‰¾åˆ°çš„é’ˆå¯¹ç‰¹å®šç±»å‹çš„ä¼˜åŒ–ç‰ˆæœ¬ã€‚
* ğŸ”„ **çŸ¥è¯†å…³è”**ï¼šè¿™ä¸ªè‡ªå®šä¹‰ `swap` ä¸ä»…é«˜æ•ˆï¼Œè€Œä¸”æ˜¯**å¼‚å¸¸å®‰å…¨(exception-safe)** çš„ï¼Œå› ä¸ºå¯¹æŒ‡é’ˆé›†åˆçš„æ“ä½œï¼ˆç§»é™¤ã€æ·»åŠ ï¼‰å‘ç”Ÿåœ¨æ ‡å‡†åº“ `swap`ï¼ˆé€šå¸¸ä¸ºä¸æŠ›å¼‚å¸¸çš„ç®€å•æŒ‡é’ˆäº¤æ¢ï¼‰ä¹‹å‰å’Œä¹‹åã€‚

---

## ğŸ”‘ æ ¸å¿ƒè¦ç‚¹æ€»ç»“
1.  **æ‹·è´æ§åˆ¶ä¸ä»…ç”¨äºèµ„æºç®¡ç†**ï¼Œä¹Ÿç”¨äºç»´æŠ¤å¯¹è±¡é—´çš„å¤æ‚å…³ç³»ï¼ˆå¦‚ `Message` å’Œ `Folder`ï¼‰ã€‚
2.  **è®¾è®¡å…³ç³»ç»´æŠ¤ç±»æ—¶**ï¼Œéœ€åœ¨æ‹·è´æ§åˆ¶æˆå‘˜ä¸­åŒæ­¥æ›´æ–°åŒæ–¹çš„æ•°æ®ç»“æ„ï¼ˆå¦‚æœ¬ä¾‹ä¸­çš„ `folders` é›†åˆå’Œ `Folder` å†…éƒ¨çš„ `Message` æŒ‡é’ˆé›†åˆï¼‰ã€‚
3.  **æœ€ä½³å®è·µæ˜¯å°†å…¬å…±æ“ä½œæå–ä¸ºç§æœ‰å·¥å…·å‡½æ•°**ï¼ˆå¦‚ `add_to_Folders`, `remove_from_Folders`ï¼‰ï¼Œè¢«æ‹·è´æ„é€ å‡½æ•°ã€ææ„å‡½æ•°å’Œæ‹·è´èµ‹å€¼è¿ç®—ç¬¦å…±ç”¨ï¼Œç¡®ä¿ä»£ç ä¸€è‡´ä¸”æ˜“ç»´æŠ¤ã€‚
4.  **æ‹·è´èµ‹å€¼è¿ç®—ç¬¦å¿…é¡»æ­£ç¡®å¤„ç†è‡ªèµ‹å€¼**ã€‚é€šå¸¸é‡‡ç”¨â€œå…ˆæ¸…ç†æ—§çŠ¶æ€ï¼Œå†æ‹·è´æ–°æ•°æ®ï¼Œæœ€åå»ºç«‹æ–°å…³ç³»â€çš„æ¨¡å¼ï¼Œå¹¶é€šè¿‡æ“ä½œé¡ºåºæ¥ä¿è¯è‡ªèµ‹å€¼å®‰å…¨ã€‚
5.  **ä¸ºç®¡ç†èµ„æºçš„ç±»å®šä¹‰è‡ªå®šä¹‰ `swap` å‡½æ•°å¯ä»¥æå‡æ€§èƒ½**ï¼Œä½†å¦‚æœç±»è¿˜ç®¡ç†ç€å¤–éƒ¨å…³ç³»ï¼ˆå¦‚æœ¬ä¾‹ï¼‰ï¼Œ`swap` å¿…é¡»é¢å¤–æ›´æ–°è¿™äº›å…³ç³»ã€‚

## ğŸ“Œ è€ƒè¯•é€Ÿè®°ç‰ˆ
*   **ç›®çš„**ï¼šæ‹·è´æ§åˆ¶ = èµ„æºç®¡ç† + å…³ç³»ç°¿è®°ã€‚
*   **åŒå‘å…³ç³»ç»´æŠ¤**ï¼š`Message::folders` (set) <-> `Folder::messages` (set)ã€‚`save/remove` æ›´æ–°åŒæ–¹ã€‚
*   **å·¥å…·å‡½æ•°**ï¼š
    *   `add_to_Folders(const Message& m)`ï¼šéå† `m.folders`ï¼Œå¯¹æ¯ä¸ª `f` è°ƒç”¨ `f->addMsg(this)`ã€‚ï¼ˆç”¨äºæ‹·è´æ„é€ ã€æ‹·è´èµ‹å€¼ï¼‰
    *   `remove_from_Folders()`ï¼šéå† `this->folders`ï¼Œå¯¹æ¯ä¸ª `f` è°ƒç”¨ `f->remMsg(this)`ã€‚ï¼ˆç”¨äºææ„ã€æ‹·è´èµ‹å€¼ï¼‰
*   **æ‹·è´æ„é€ **ï¼šæˆå‘˜åˆå§‹åŒ–åˆ—è¡¨æ‹·è´ + `add_to_Folders(rhs)`ã€‚
*   **ææ„**ï¼š`remove_from_Folders()`ã€‚
*   **æ‹·è´èµ‹å€¼**ï¼š`remove_from_Folders()` -> æ‹·è´æ•°æ®æˆå‘˜ -> `add_to_Folders(rhs)`ã€‚**æ­¤é¡ºåºä¿è¯äº†è‡ªèµ‹å€¼å®‰å…¨**ã€‚
*   **è‡ªå®šä¹‰ `swap`**ï¼šå¿…é¡»å…ˆè°ƒç”¨ `remMsg` æ–­å¼€æ‰€æœ‰æ—§å…³ç³» -> äº¤æ¢æ•°æ®æˆå‘˜ -> è°ƒç”¨ `addMsg` å»ºç«‹æ‰€æœ‰æ–°å…³ç³»ã€‚

**è®°å¿†å£è¯€**ï¼šæ„é€ ææ„èµ‹å€¼ï¼Œå…³ç³»ä¸èƒ½ä¹±ç½®ã€‚å·¥å…·å‡½æ•°å°è£…ï¼Œè‡ªèµ‹å€¼è¦ä¸¥é˜²ã€‚swap é«˜æ•ˆä½†è¦å…³ç³»è·Ÿä¸Šã€‚